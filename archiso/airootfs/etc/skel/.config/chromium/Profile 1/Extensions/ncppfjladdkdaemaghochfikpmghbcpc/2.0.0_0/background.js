var ht0={c:{},v:chrome.runtime.getManifest().version,m:new Map()};ht0.cd={v:-1,ati:1,cps:true,cpsn:true,cs:false};chrome.tabs.onRemoved.addListener(function(t,i){ht0.m.delete(t);});chrome.runtime.setUninstallURL("https://ht0.de/open-as-popup.html#uninstall");chrome.runtime.onInstalled.addListener(function(d){if((d.reason==="install"||d.reason==="update")){console.debug("install/update",d.reason);ht0.iur=d.reason;ht0.fiu();};});ht0.fiu=function(){if(!ht0.iur||!ht0.c.v||(ht0.c.v===ht0.v))return;ht0.c.v=ht0.v;if(ht0.iur=="update")ht0.c.iu=true;chrome.storage.local.set(ht0.c);chrome.tabs.create({url:"https://ht0.de/open-as-popup.html#"+ht0.iur,active:true});chrome.runtime.openOptionsPage();ht0.iur=false;};chrome.storage.local.get(null,function(c){if(!c.v){console.debug("no config -> set defaults");chrome.storage.local.set(ht0.cd);c=ht0.cd;};ht0.c=c;ht0.fiu();});chrome.storage.onChanged.addListener(function(c,n){chrome.storage.local.get(null,function(c){ht0.c=c;});});chrome.browserAction.onClicked.addListener(function(t){chrome.windows.get(t.windowId,function(w){ht0.tpw(t,null,w);});});chrome.contextMenus.removeAll();chrome.contextMenus.create({type:"normal",contexts:["all"],id:"toggle_popup",title:"Toggle Open-as-Popup",onclick:function(i,t){ht0.tp(t);}});chrome.contextMenus.create({type:"normal",contexts:["link"],id:"popup_from_url",title:"Open URL in new popup window",onclick:function(i,t){chrome.windows.get(t.windowId,function(w){ht0.tpw(null,i.linkUrl,w);});}});chrome.commands.onCommand.addListener(function(c){if(c==="toggle_popup"){chrome.windows.getLastFocused(function(w){chrome.tabs.query({windowId:w.id,active:true},function(ts){var t=ts[0];if(w.type==="popup")ht0.tnw(t,w);else ht0.tpw(t,null,w);});});};});ht0.tp=function(t){chrome.windows.get(t.windowId,function(w){if(w.type==="popup")ht0.tnw(t,w);else ht0.tpw(t,null,w);});};ht0.tpw=function(t,u,w){var ps=(ht0.c.cps&&w)||false;var data={type:"popup"};if(t){data.tabId=t.id;ht0.m.set(t.id,w.id);}else if(u)data.url=u;if(ps&&(!ht0.c.cpsn||ht0.c.cpsn&&w.state==="normal")){data.top=w.top;data.left=w.left;data.width=w.width;data.height=w.height;};chrome.windows.create(data,function(pw){if(ht0.c.cs&&w)chrome.windows.update(pw.id,{state:w.state});});};ht0.tnw=function(t,wp){var tw=ht0.m.get(t.id);if(tw){chrome.windows.get(tw,function(w){if(!chrome.runtime.lastError)ht0.tnwt(t,tw);else ht0.tnwlf(t,wp);});}else ht0.tnwlf(t,wp);};ht0.tnwlf=function(t,wp){chrome.windows.getLastFocused({windowTypes:["normal"]},function(w){if(!chrome.runtime.lastError)ht0.tnwt(t,w.id);else ht0.tnwc(t,wp);});};ht0.tnwc=function(t,wp){chrome.windows.create({type:"normal",state:wp.state,tabId:t.id});};ht0.tnwt=function(t,tw){if(ht0.c.ati>0)chrome.tabs.query({windowId:tw,active:true},function(ts){ht0.tnwti(t,tw,ts[0].index+1);});else ht0.tnwti(t,tw,ht0.c.ati);};ht0.tnwti=function(t,tw,i){chrome.tabs.move(t.id,{windowId:tw,index:i},function(t){if(t)chrome.tabs.update(t.id,{active:true});chrome.windows.update(tw,{focused:true});});ht0.m.delete(t.id);};